<!DOCTYPE html>
<html>

<head>
    <title>キンブレ３次元コード作るやつ</title>
    <meta charset="UTF-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        table {
            border-collapse: collapse;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 6px 10px;
            text-align: center;
            vertical-align: middle;
        }

        #csv-text {
            width: 40ch;
        }

        #app-wrapper {
            display: inline-block;
        }

        .preview {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 1px solid #000;
        }

        #table-wrapper {
            display: inline-block;
            margin-top: 12px;
        }

        #controls-wrapper {
            display: flex;
            justify-content: space-between;
            margin: 12px 0 12px 0;
        }

        #bulk-add-wrapper {
            margin-top: 32px;
            padding: 12px 0 12px 0;
            border: #ccc solid 1px;
            text-align: center;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <div id="app-wrapper">

        <div id="qr-container"></div>

        <form onsubmit="return handleUpdateQr()">
            <div>
                <select id="target-device"></select>
                <input id="blade-name" value="Name" type="text" pattern="[\x20-\x7E]{1,100}" maxlength="100"
                    required></input>
            </div>

            <div id="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Preview</th>
                            <th>RGB</th>
                            <th>White</th>
                            <th>Delete</th>
                        </tr>
                    </thead>
                    <tbody id="color-rows-container"></tbody>
                </table>
                <div id="controls-wrapper">
                    <button type="button" onclick="resetAll()">リセット</button>
                    <div>
                        <button type="button" onclick="addRow()">行を追加</button>
                        <button type="submit">３次元コード生成</button>
                    </div>
                </div>
            </div>

        </form>

        <div id="bulk-add-wrapper">
            <form onsubmit="return handleBulkAdd()">
                <input id="csv-text" type="text" placeholder="カンマ区切りカラーコード(6 or 8桁)"></input>
                <button type="submit">一括追加</button>
                <button type="button" onclick="applyCsvTextFromTable()">表から取得</button>
            </form>
        </div>

    </div>


    <script>
        const DEVICES = { KBX5: 'KBX5' };
        const HEADERS = {
            [DEVICES.KBX5]: 'Copyright RUIFAN:KBX5',
        };
        const RESERVED_SUFFIX = "00";

        function init() {
            const targetDevice = document.getElementById("target-device");
            targetDevice.replaceChildren();
            Object.values(DEVICES).forEach(device => {
                const option = document.createElement("option");
                option.value = device;
                option.textContent = device;
                targetDevice.appendChild(option);
            });
            targetDevice.selectedIndex = 0;
            targetDevice.addEventListener("change", () => {
                const selected = targetDevice.value;
            });
        }

        function resetAll() {
            if (!confirm("初期化するわよ")) return;
            document.getElementById("blade-name").value = document.getElementById("blade-name").defaultValue;
            document.getElementById("color-rows-container").replaceChildren();
            document.getElementById("qr-container").replaceChildren();
            addRow();
            handleUpdateQr();
        }

        /**
         * カラー入力行をテーブルに追加する。
         * @param {string} [rgb="ffffff"] RGB値
         * @param {string} [white="00"] White値
         * @returns {void}
         */
        function addRow(rgb = "ffffff", white = "00") {
            const colorRowsContainer = document.getElementById("color-rows-container");
            const tr = document.createElement("tr");

            // RGB color picker
            const rgbPicker = document.createElement("input");
            rgbPicker.type = "color";
            rgbPicker.value = "#" + rgb;

            // RGB text input
            const rgbText = document.createElement("input");
            rgbText.type = "text";
            rgbText.maxLength = 6;
            rgbText.pattern = "[0-9a-f]{6}";
            rgbText.placeholder = "RRGGBB";
            rgbText.required = true;
            rgbText.value = rgb;

            // Sync
            function syncFromPicker() {
                const hex = rgbPicker.value.replace("#", "");
                rgbText.value = hex;
            }
            function syncFromText() {
                if (/^[0-9a-fA-F]{6}$/.test(rgbText.value)) {
                    rgbPicker.value = "#" + rgbText.value;
                }
            }
            rgbPicker.addEventListener("input", syncFromPicker);
            rgbText.addEventListener("input", syncFromText);
            syncFromPicker();

            // White input
            const whiteInput = document.createElement("input");
            whiteInput.type = "text";
            whiteInput.maxLength = 2;
            whiteInput.pattern = "[0-9a-f]{2}";
            whiteInput.placeholder = "WW";
            whiteInput.value = white;

            // Delete Button
            const deleteBtn = document.createElement("button");
            deleteBtn.type = "button";
            deleteBtn.textContent = "×";
            deleteBtn.onclick = () => tr.remove();

            // Build TD
            const previewTd = document.createElement("td");
            previewTd.appendChild(rgbPicker);

            const rgbTd = document.createElement("td");
            rgbTd.appendChild(rgbText);

            const whiteTd = document.createElement("td");
            whiteTd.appendChild(whiteInput);

            const deleteTd = document.createElement("td");
            deleteTd.appendChild(deleteBtn);

            // Append TD
            tr.appendChild(previewTd);
            tr.appendChild(rgbTd);
            tr.appendChild(whiteTd);
            tr.appendChild(deleteTd);

            colorRowsContainer.appendChild(tr);
        }

        /**
         * 指定した文字列からQRコードを生成する。
         * @param {string} source QRコードに埋め込む文字列
         * @returns {void}
         */
        function generateQR(source) {
            const qrContainer = document.getElementById("qr-container");
            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {
                text: source.replace(/\r\n|\r/g, "\n"),
                width: 400,
                height: 400,
                correctLevel: QRCode.CorrectLevel.L,
                version: 20,
            });
        }

        /**
         * QR更新ボタンハンドラ
         * @returns {boolean} (false)
         */
        function handleUpdateQr() {
            const targetDevice = document.getElementById("target-device").value;
            const bladeName = document.getElementById("blade-name").value;

            if (!HEADERS[targetDevice]) {
                alert("Device error");
                return false;
            }

            const header = HEADERS[targetDevice];
            const rawLines = getColorLinesFromTable();

            // RRGGBBWW00   
            const lines = rawLines.map(l => l + RESERVED_SUFFIX);

            const payload =
                header + "\n" +
                bladeName + "\n" +
                lines.join("\n");

            generateQR(payload)

            return false;
        }

        /**
         * テーブルの内容からQR用カラーコード配列を生成する。
         * @returns {string[]} rrggbbww 形式の文字列配列
         */
        function getColorLinesFromTable() {
            const rows = document.querySelectorAll("#color-rows-container tr");
            const lines = [];
            for (const row of rows) {
                const inputs = row.querySelectorAll("input");
                const rgb = inputs[1].value;
                const white = inputs[2].value;
                lines.push(rgb.toLowerCase() + white.toLowerCase());
            }
            return lines;
        }

        /**
         * 一括追加ボタンハンドラ
         * @returns {boolean} (false)
         */
        function handleBulkAdd() {
            const text = document.getElementById("csv-text").value;
            if (!text) return false;

            text.split(",").forEach(entry => {
                const value = entry.trim().replace(/^#/, "");

                if (!/^[0-9a-fA-F]{6}([0-9a-fA-F]{2})?$/.test(value)) return;

                const rgb = value.slice(0, 6);
                const white = value.length === 8 ? value.slice(6, 8) : "00";

                addRow(rgb, white);
            });

            document.getElementById("csv-text").value = "";

            handleUpdateQr();
            return false;
        }

        function applyCsvTextFromTable() {
            const lines = getColorLinesFromTable();
            const text = lines.join(",");
            document.getElementById("csv-text").value = text;
        }

        // init
        init();
        addRow();
        handleUpdateQr();

    </script>

</body>

</html>